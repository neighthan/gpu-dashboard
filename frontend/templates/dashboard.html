<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GPU Runner</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
    <link href="https://unpkg.com/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>

<v-app id="app">
  <v-toolbar color="primary">
    <v-toolbar-title>GPU Runner</v-toolbar-title>
    <v-spacer></v-spacer>
    <v-toolbar-items>
      <v-btn flat href="/logout">Logout</v-btn>
    </v-toolbar-items>
  </v-toolbar>

  <main>
    <v-container fluid id="left">
      <v-card>
        <v-card-title class="mt-3 title">GPU Usage</v-card-title>
        <v-card-text>
          <ul v-for="gpu in gpuUsage">
            <li>GPU [[ gpu.num ]]: [[ gpu.mem_used ]] / [[ gpu.mem_free + gpu.mem_used ]] MiB [[ gpu.util_used ]]%</li>
          </ul>
        </v-card-text>
      </v-card>
    </v-container>

    <v-container fluid id="right">
      <v-card>
        <v-card-title class="mt-3 title">New Jobs</v-card-title>
        <v-card-text>
          <v-container fluid>
            <v-layout row>
              <v-btn icon @click="removeVar"><v-icon>remove</v-icon></v-btn>
              <v-btn icon @click="addVar"><v-icon>add</v-icon></v-btn>
            </v-layout>
            <v-layout row v-for="(job, idx) in job_vars" :key="idx">
              <v-flex xs1>
                <v-subheader>For</v-subheader>
              </v-flex>
              <v-flex xs2>
                <v-text-field label="name" v-model="job.name"></v-text-field>
              </v-flex>
              <v-flex xs1>
                <v-subheader>in</v-subheader>
              </v-flex>
              <v-flex xs4>
                <v-text-field label="values" v-model="job.values"></v-text-field>
              </v-flex>
            </v-layout>

            <v-text-field label="command" v-model="command"></v-text-field>

            <v-layout row>
              <v-flex xs3 class="mr-3">
                <v-text-field label="Memory Needed" suffix="MiB" v-model.number="mem_needed"></v-text-field>
              </v-flex>
              <v-flex xs3>
                <v-text-field label="Utilization Needed" suffix="%" v-model.number="util_needed"></v-text-field>
              </v-flex>
            </v-layout>

            <v-btn @click="generateCommands">Generate</v-btn>
            <v-text-field full-width multi-line v-model="generatedCommands"></v-text-field>
            <v-btn @click="submitCommands">Submit</v-btn>
          </v-container>
        </v-card-text>
      </v-card>

      <v-card>
        <v-card-title class="mt-3 title">
          Jobs Queued
          <v-spacer></v-spacer>
          <v-text-field append-icon="search" label="Search" single-line v-model="search"></v-text-field>
        </v-card-title>
        <v-card-text>
          <v-data-table :headers="headers" :items="jobs" :search="search">
            <template slot="items" slot-scope="props">
              <td>[[ props.item.mem ]]</td>
              <td>[[ props.item.util ]]</td>
              <td>[[ props.item.command ]]</td>
            </template>
          </v-data-table>
        </v-card-text>
      </v-card>
    </v-container>
  </main>

  <v-footer color="primary"></v-footer>
</v-app>

<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vuetify/dist/vuetify.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.4"></script>

<script>
    let refreshDelay = 30000

    const vue = new Vue({
        el: '#app',
        data: {
            job_vars: [
                {
                    name: '',
                    values: ''
                }
            ],
            command: '',
            mem_needed: 0,
            util_needed: 0,
            generatedCommands: '',
            gpuUsage: '',
            jobs: [],
            headers: [
                {text: 'Memory', value: 'mem'},
                {text: 'Utilization', value: 'util'},
                {text: 'Command', value: 'command'}
            ],
            search: ''
        },
        methods: {
            removeVar: function() {
                this.job_vars.pop()
            },
            addVar: function() {
                this.job_vars.push({
                    name: '',
                    values: ''
                })
            },
            generateCommands: function() {
                // make one command with each possible combination of the values of the different variables

                let n_commands = this.job_vars.map((job_var) => job_var.values.split(', ').length)
                    .reduce((product, length) => product * length, 1)

                let commands = Array(n_commands).fill([this.mem_needed, this.util_needed, this.command].join('|'))

                let switch_value_every = 1

                for (let job_var of this.job_vars) {
                    let name = job_var['name']
                    let values = job_var['values'].split(', ')
                    let value_idx = 0
                    let last_switched = 0

                    commands.forEach((command, idx) => {
                        commands[idx] = command.replace(`{${name}}`, values[value_idx])
                        last_switched += 1
                        if (last_switched === switch_value_every) {
                            last_switched = 0
                            value_idx = (value_idx + 1) % values.length
                        }
                    })
                    switch_value_every *= values.length
                }
                this.generatedCommands = commands.join('\n')
            },
            submitCommands: function() {
                this.$http.post('/dashboard', {commands: this.generatedCommands.trim() + '\n'})
                this.generatedCommands = ''
            },
            getData: function() {
                $.getJSON('/data/gpu', (response) => {
                    this.gpuUsage = response
                })

                $.getJSON('/data/jobs', (jobs) => {
                    this.jobs = []
                    for (let job of jobs) {
                        job = job.split('|')
                        this.jobs.push({
                            mem: job[0],
                            util: job[1],
                            command: job[2]
                        })
                    }
                })
            }
        },
        mounted: function() {
            this.getData()

            setInterval(() => {
                this.getData()
            }, refreshDelay)
        },
        delimiters: ["[[", "]]"]
    })
</script>
</body>
</html>